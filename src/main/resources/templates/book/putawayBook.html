<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>å›¾ä¹¦ä¸Šæ¶</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="Access-Control-Allow-Origin" content="*">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link rel="icon" href="/resources/favicon.ico">
    <link rel="stylesheet" href="/resources/layui/css/layui.css" media="all"/>
    <link rel="stylesheet" href="/resources/css/public.css" media="all"/>
</head>
<body class="childrenBody">

<!--æŸ¥è¯¢æ¡ä»¶å¼€å§‹-->
<fieldset class="layui-elem-field layui-field-title" style="margin-top: 0;">
    <legend>æŸ¥è¯¢æ¡ä»¶</legend>
</fieldset>

<blockquote class="layui-elem-quote">
    <!--æ¡ä»¶æŸ¥è¯¢è¡¨å•-->
    <form class="layui-form layui-form-pane" action="" method="post" id="searchForm" lay-filter="searchForm">
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label" for="booknum">å›¾ä¹¦åºåˆ—å·</label>
                <div class="layui-input-inline">
                    <input type="text" name="booknum" id="booknum" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label" for="name">å›¾ä¹¦åç§°</label>
                <div class="layui-input-inline">
                    <input type="text" name="name" id="name" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label" for="author">å›¾ä¹¦ä½œè€…</label>
                <div class="layui-input-inline">
                    <input type="text" name="author" id="author" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label" for="putawayStatus">ä¸Šæ¶çŠ¶æ€</label>
                <div class="layui-input-inline">
                    <select name="putaway" id="putawayStatus" lay-search>
                        <option value="" selected>æœªé€‰æ‹©</option>
                        <option value="0" >æœªä¸Šæ¶</option>
                        <option value="1" >å·²ä¸Šæ¶</option>
                    </select>
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label" for="category">å›¾ä¹¦åˆ†ç±»</label>
                <div class="layui-input-inline">
                    <select name="fkCategoryid" id="category" lay-search>
                    </select>
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label" for="publisher">å‡ºç‰ˆç¤¾</label>
                <div class="layui-input-inline">
                    <select name="fkPublisherid" id="publisher" lay-search>
                    </select>
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label" for="startTime">å‡ºç‰ˆå¼€å§‹æ—¥</label>
                <div class="layui-input-inline">
                    <input type="text" name="startTime" id="startTime" placeholder="yyyy-MM-dd HH:mm:ss" readonly="readonly" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label" for="endTime">å‡ºç‰ˆç»“æŸæ—¥</label>
                <div class="layui-input-inline">
                    <input type="text" name="endTime" id="endTime" placeholder="yyyy-MM-dd HH:mm:ss" readonly="readonly" autocomplete="off" class="layui-input">
                </div>
            </div>
        </div>
        <!--æŸ¥è¯¢è¡¨å•æŒ‰é’®-->
        <div class="layui-row layui-col-space1">
            <div class="layui-col-md4">
                <!--å ä½-->
                <div class="grid-demo grid-demo-bg1"></div>
            </div>
            <div class="layui-col-md4">
                <div class="grid-demo grid-demo-bg1">
                    <div class="layui-form-item" style="">
                        <div class="layui-input-block">
                            <button type="button" class="layui-btn layui-btn-normal" lay-submit="" lay-filter="doSearch">
                                <i class="layui-icon layui-icon-search"></i>
                                æœç´¢
                            </button>
                            <button type="reset" class="layui-btn layui-btn-primary">
                                <i class="layui-icon layui-icon-refresh-1"></i>
                                é‡ç½®
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-col-md4">
                <!--å ä½-->
                <div class="grid-demo grid-demo-bg1"></div>
            </div>
        </div>
    </form>
</blockquote>
<!--æŸ¥è¯¢æ¡ä»¶ç»“æŸ-->

<!--åœ¨çº¿ä¹¦æ¶ å¼€å§‹-->
<fieldset class="layui-elem-field layui-field-title" style="margin-top: 0;">
    <legend>åœ¨çº¿ä¹¦æ¶</legend>
</fieldset>

<ul class="flow-default" style="height: 300px; margin-bottom: 50px;" id="bookRack" ></ul>
<!--åœ¨çº¿ä¹¦æ¶ ç»“æŸ-->

<script type="text/javascript" src="/resources/layui/layui.js"></script>
<script type="text/javascript">
    layui.use(['form', 'layer', 'jquery', 'upload', 'laydate', 'flow'], function () {
        var form = layui.form;
        var layer = layui.layer;
        var $ = layui.jquery;
        var upload = layui.upload;
        var laydate = layui.laydate;
        var flow = layui.flow;

        // åˆå§‹åŒ–å¼€å§‹æ—¶é—´é€‰æ‹©å™¨
        var startTime = laydate.render({
            elem: '#startTime',
            type: 'datetime',
            theme: '#4d99cf',
            istoday: true,
            done: function (value, date) {
                date.month = date.month !== 1 ? date.month - 1 : (date.year--, 12);// æœˆä»½ä¿®æ­£
                endTime.config.min = date;      // å¼€å§‹æ—¥é€‰å¥½åï¼Œé‡ç½®ç»“æŸæ—¥çš„æœ€å°æ—¥æœŸ
                endTime.config.value = value;   // å°†ç»“æŸæ—¥çš„åˆå§‹å€¼è®¾å®šä¸ºå¼€å§‹æ—¥
                $("#endTime").val(value);       // ç»™ç»“æŸæ—¶é—´èµ‹å€¼
            }
        });

        // åˆå§‹åŒ–ç»“æŸæ—¶é—´é€‰æ‹©å™¨
        var endTime = laydate.render({
            elem: '#endTime',
            type: 'datetime',
            max: '2099-06-16 23:59:59',
            istoday: true,
            theme: '#4d99cf',
            done: function (value, date) {
                console.log(endTime);
                // å¦‚æœç»“æŸæ—¶é—´å°äºå¼€å§‹æ—¶é—´ï¼Œå°±è®©å¼€å§‹æ—¶é—´=ç»“æŸæ—¶é—´
                var start = $("#startTime"), end = $("#endTime");
                if (start.val() > end.val()) {
                    start.val(end.val());
                }
            }
        });

        // è·å–ä¹¦ç±åˆ†ç±»çš„å€¼
        $.ajax({
            url: '/category/getPageCategory?pageNum=1&pageSize=100',
            dataType: 'json',   //æœåŠ¡å™¨è¿”å›jsonæ ¼å¼æ•°æ®
            type: 'get',        //HTTPè¯·æ±‚ç±»å‹
            timeout: 5000,      //è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º5ç§’ï¼›
            success: function (data) {
                // console.log(data.list);
                //ç»™ä¸€ä¸ªé»˜è®¤å€¼ï¼ˆâ€˜è¯·é€‰æ‹©â€™ï¼‰
                var opt = '<option value="" selected="">è¯·é€‰æ‹©</option>';
                //è·å–è¿”å›çš„æ•°æ®
                var value = data.list;
                //å¾ªç¯éå†
                for (var i in value) {
                    opt += '<option value = "' + value[i].id + '">' + value[i].name + '</option>'
                }
                $("#category").html(opt);
                form.render('select');//éœ€è¦æ¸²æŸ“ä¸€ä¸‹
            }
        });

        // è·å–å‡ºç‰ˆç¤¾çš„å€¼
        $.ajax({
            url: '/publisher/getPagePublisher?pageNum=1&pageSize=100',
            dataType: 'json',   //æœåŠ¡å™¨è¿”å›jsonæ ¼å¼æ•°æ®
            type: 'get',        //HTTPè¯·æ±‚ç±»å‹
            timeout: 5000,      //è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º5ç§’ï¼›
            success: function (data) {
                //ç»™ä¸€ä¸ªé»˜è®¤å€¼ï¼ˆâ€˜è¯·é€‰æ‹©â€™ï¼‰
                var opt = '<option value="" selected="">è¯·é€‰æ‹©</option>';
                //è·å–è¿”å›çš„æ•°æ®
                var value = data.list;
                //å¾ªç¯éå†
                for (var i in value) {
                    opt += '<option value = "' + value[i].id + '">' + value[i].name + '</option>'
                }
                $("#publisher").html(opt);
                form.render('select');//éœ€è¦æ¸²æŸ“ä¸€ä¸‹
            }
        });

        // åˆå§‹åŒ–æµåŠ è½½
        flowload();

        //æ¨¡ç³ŠæŸ¥è¯¢
        form.on("submit(doSearch)",function(data){
            // é‡ç½®æµåŠ è½½å†…å®¹
            $("#bookRack").html("");
            // è°ƒç”¨æµåŠ è½½ï¼Œå¹¶ä¼ å‚
            flowload(data.field);
            return false;
        });

        // æµåŠ è½½
        function flowload(data) {
            flow.load({
                elem: '#bookRack' //æµåŠ è½½å®¹å™¨
                , isAuto: false
                , isLazyimg: true
                , done: function (page, next) { //åŠ è½½ä¸‹ä¸€é¡µ
                    //æ¨¡æ‹Ÿæ’å…¥
                    setTimeout(function () {
                        var lis = [];
                        var info = { pageNum: page, pageSize: 8 };
                        // æµ…æ‹·è´
                        $.extend(info, data);
                        console.log("info:", info);
                        $.get('/book/getPageBook', info, function (res) {
                            layui.each(res.list, function (index, item) {

                                var intro = "";     // ç®€ä»‹ï¼Œçº¯æ–‡æœ¬å†…å®¹
                                var status = "";    // ä¸Šæ¶çŠ¶æ€
                                var action = "";    // æ“ä½œ
                                var bgColor = "";   // æŒ‰é’®èƒŒæ™¯è‰²
                                if (item.text.length > 40) {
                                    intro = item.text.substring(0, 40)+"... ";
                                } else {
                                    intro = item.text;
                                }
                                if (item.putaway > 0) {
                                    status = "å·²ä¸Šæ¶"; action = "ä¸‹æ¶å›¾ä¹¦"; bgColor = "layui-btn-danger";
                                } else {
                                    status = "æœªä¸Šæ¶"; action = "ä¸Šæ¶å›¾ä¹¦"; bgColor = "layui-btn-warm";
                                }

                                //æ‰§è¡Œä¸‹ä¸€é¡µæ¸²æŸ“ï¼Œç¬¬äºŒå‚æ•°ä¸ºï¼šæ»¡è¶³â€œåŠ è½½æ›´å¤šâ€çš„æ¡ä»¶ï¼Œå³åé¢ä»æœ‰åˆ†é¡µ
                                //æµåŠ è½½æ’å…¥å†…å®¹éƒ¨åˆ†ï¼Œæ ¹æ®è‡ªå·±éœ€æ±‚æ›´æ”¹ï¼Œè¿™é‡Œåšçš„æ¡ˆä¾‹ï¼Œæ‰€ä»¥å°±å†™çš„æ¯”è¾ƒç®€å•
                                lis.push('<div class="layui-col-sm3">' +
                                    '       <div class="grid-demo grid-demo-bg1" style="border: 1px solid #dcdedb; min-height: 180px; margin: 3px;">      ' +
                                    '           <div style="display:inline;">                                                                             ' +
                                    '               <div class="layui-input-inline" >                                                                     ' +
                                    '                   <img src="' + item.src + '" alt="'+ item.alt +'" style="width: 120px; height: 145px; ">           ' +
                                    '               </div>                                                                                                ' +
                                    '               <div class="layui-input-inline" style="max-width: 180px; height: 145px; margin-left: 3px; ">          ' +
                                    '                   <hr class="layui-bg-white" style="margin: 1px;">                                                  ' +
                                    '                   <span style="padding: 2px; background-color: #eae9e9; font-size: smaller; border-radius: 3px;">   ' +
                                    '                       ğŸ“” ä¹¦åï¼š '+ item.name +'</span><hr class="layui-bg-white" style="margin: 1px;">              ' +
                                    '                   <span style="padding: 2px; font-size: smaller; border-radius: 3px;">                              ' +
                                    '                       âœ ä½œè€…ï¼š '+ item.author +'</span><hr class="layui-bg-white" style="margin: 1px;">             ' +
                                    '                   <span style="padding: 2px; background-color: #eae9e9; font-size: smaller; border-radius: 3px;">   ' +
                                    '                       â° å‡ºç‰ˆæ—¶é—´ï¼š<br>'+  item.publishTime +'</span><hr class="layui-bg-white" style="margin: 1px;">' +
                                    '                   <span style="padding: 2px;  font-size: smaller; border-radius: 3px;">                             ' +
                                    '                       ğŸ“– ç®€ä»‹ï¼š<br>'+ intro +'</span><hr class="layui-bg-white" style="margin: 1px;">               ' +
                                    '               </div>                                                                                                ' +
                                    '           </div>                                                                                                    ' +
                                    '           <div class="layui-input-inline" style="width: 98%; height: 25px; border: 0 solid #FD482C; margin-left: 3px; ">'+
                                    '               <hr class="layui-bg-white" style="margin: 1px;">                                                      ' +
                                    '               <span class="layui-badge layui-bg-blue">çŠ¶æ€ï¼š'+ status +'</span> â€–                                    ' +
                                    '               <span style="padding: 2px; font-size: smaller; ">æ“ä½œï¼š                                                ' +
                                    '                   <button index="'+index+'" class="layui-btn layui-btn-xs '+bgColor+' putawayfun">'+action+'</button> ' +
                                    // '                   <button onclick="putawayfun(\''+item.id+'\', \''+item.putaway+'\')" class="layui-btn layui-btn-xs '+bgColor+'">'+action+'</button> ' +
                                    '               </span>                                                                                                ' +
                                    '           </div>                                                                                                     ' +
                                    '       </div>                                                                                                         ' +
                                    '    </div>                                                                                                            ');
                            });
                            lis.push('<hr class="layui-bg-orange">');
                            //totalä¸ºAjaxè¿”å›çš„æ€»é¡µæ•°ï¼Œåªæœ‰å½“å‰é¡µå°äºæ€»é¡µæ•°çš„æƒ…å†µä¸‹ï¼Œæ‰ä¼šç»§ç»­å‡ºç°åŠ è½½æ›´å¤š
                            next(lis.join(''), page < res.pages); //å‡è®¾æ€»é¡µæ•°ä¸º 10
                            $(".putawayfun").click(function(){
                                var data = res.list[parseInt($(this).attr("index"))];
                                // console.log(data);
                                putawayfun_2(data);
                            });
                        })
                    }, 500);
                }
            });
        }

        // æ–¹å¼ä¸€ï¼šå›¾ä¹¦ä¸Šæ¶ä¸‹æ¶,jsæ‹¼æ¥çš„ç‚¹å‡»äº‹ä»¶ä¸€å®šè¦è¿™æ ·å†™æ‰è¡Œ,æ–¹å¼ä¸€
        putawayfun = function (data1, data2) {
            console.log(data1, data2);
            var tips = data2 > 0 ? "ä¸‹æ¶" : "ä¸Šæ¶";
            layer.confirm('ä½ ç¡®å®šè¦'+ tips +'è¿™æœ¬ä¹¦å—?', {icon: 3, title: 'æç¤º'}, function (index) {
                $.post("/book/putawayBook", {id: data1, putaway: data2}, function (res) {
                    layer.msg(res.msg);
                    if (res.code === 200) {
                        // é‡ç½®æµåŠ è½½å†…å®¹
                        $("#bookRack").html("");
                        flowload();
                    }
                })
            });
        };

        // æ–¹å¼äºŒï¼š
        function putawayfun_2(data) {
            console.log(data);
            var tips = data.putaway > 0 ? "ä¸‹æ¶" : "ä¸Šæ¶";
            layer.confirm('ä½ ç¡®å®šè¦'+ tips +'è¿™æœ¬ä¹¦å—?', {icon: 3, title: 'æç¤º'}, function (index) {
                $.post("/book/putawayBook", data, function (res) {
                    layer.msg(res.msg);
                    if (res.code === 200) {
                        // é‡ç½®æµåŠ è½½å†…å®¹
                        $("#bookRack").html("");
                        flowload();
                    }
                })
            });
        }
    });
</script>

</body>
</html>
